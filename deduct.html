<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deduct Part</title>
    <style>
        body { font-family: sans-serif; background: #f1f5f9; margin: 0; }
        .container { max-width: 500px; margin: 20px auto; padding: 0 15px; }
        .card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        input { width: 100%; padding: 15px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; margin-bottom: 20px; font-size: 18px; }
        label { font-weight: bold; display: block; margin-bottom: 8px; color: #475569; }
        .confirm-btn { width: 100%; padding: 18px; background: #ef4444; color: white; border: none; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer; }
        #res-box { display: none; background: #f8fafc; padding: 15px; border-radius: 10px; border: 1px dashed #cbd5e1; margin-bottom: 20px; }
    </style>
</head>
<body onload="loadStockData()">
    <div class="container">
        <button onclick="location.href='main.html'" style="margin-bottom:15px; cursor:pointer; padding:8px 15px; border-radius:5px; border:1px solid #ccc;">‚óÄ Back</button>
        <h2 style="color:#ef4444">üìâ Deduct Part (Used)</h2>
        <div class="card">
            <label>1. WORK ORDER NUMBER (WO) *</label>
            <input type="text" id="wo" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç WO...">

            <label>2. MATERIAL CODE</label>
            <input type="text" id="mat" placeholder="Scan ‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå Material..." oninput="search(this.value)">

            <div id="res-box">
                <b id="pname" style="font-size: 16px;"></b><br>
                <span>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡∏Ñ‡∏∏‡∏ì: <b id="pqty" style="color:#16a34a; font-size: 18px;"></b></span>
                <input type="number" id="qty" value="1" min="1" style="margin-top:15px;">
                <button class="confirm-btn" onclick="submit()">CONFIRM DEDUCT</button>
            </div>
        </div>
    </div>
    <script src="js/app.js"></script>
    <script>
        let selectedItem = null;
        function search(v) {
            const user = sessionStorage.getItem('selectedUser');
            selectedItem = window.allRows.find(r => String(r.Material).toLowerCase() === v.toLowerCase().trim());
            const box = document.getElementById('res-box');
            if (selectedItem && selectedItem[user] > 0) {
                document.getElementById('pname').innerText = selectedItem['Product Name'];
                document.getElementById('pqty').innerText = selectedItem[user];
                box.style.display = 'block';
            } else { box.style.display = 'none'; }
        }
        async function submit() {
            const woVal = document.getElementById('wo').value.trim();
            const qtyVal = document.getElementById('qty').value;
            if (!woVal) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏ Work Order");
            if (!confirm(`‡∏ï‡∏±‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å ${selectedItem.Material} ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${qtyVal} ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö WO: ${woVal}?`)) return;

            const res = await window.executeDeduct(sessionStorage.getItem('selectedUser'), selectedItem.Material, qtyVal, woVal);
            if (res.success) {
                alert("‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
                location.href = 'main.html';
            } else { alert("‚ùå " + res.msg); }
        }
    </script>
</body>
</html>
