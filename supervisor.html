<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="css/style.css">
</head>
<body onload="onSupLoad()">
  <div class="header">
    <div class="title">üõ†Ô∏è Supervisor Panel</div>
    <button class="btn-ghost" onclick="goBack()">Back</button>
  </div>

  <div class="container">
    <div class="card stack">
      <h3>Add Stock to 0243 (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà)</h3>
      <div class="row">
        <input id="sup_mat_add" placeholder="Material No. (‡πÄ‡∏ä‡πà‡∏ô 9025186)" style="flex:1;">
        <input id="sup_qty_add" type="number" placeholder="Qty" style="width:80px;">
        <button class="btn-primary" onclick="supAddTo0243()">Add to Stock</button>
      </div>
    </div>

    <div class="card stack">
      <h3>Material Inspector (‡∏ï‡∏±‡∏î‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏Ñ‡∏ô‡∏ñ‡∏∑‡∏≠‡∏≠‡∏¢‡∏π‡πà)</h3>
      <label class="pill">
        <input type="checkbox" id="sup_reconcile"> Auto-reconcile with 0243
      </label>
      <div class="table-container">
        <table class="inspector-table" style="width:100%; border-collapse:collapse;">
          <thead style="background:#f1f5f9;">
            <tr>
              <th>User</th>
              <th>Material</th>
              <th>Qty Used</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="sup_users_table_body">
            <tr><td colspan="4" style="text-align:center; padding:20px;">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script src="js/app.js"></script>
  <script>
    const USERS = ['Kitti','Tatchai','Parinyachat','Phurilap','Penporn','Phuriwat'];

    async function onSupLoad() { await refreshTable(); }

    async function refreshTable() {
      await loadAllWithSchema(); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• rows ‡∏à‡∏≤‡∏Å app.js
      const tbody = document.getElementById('sup_users_table_body');
      let html = '';
      rows.forEach(row => {
        USERS.forEach(user => {
          const val = Number(row[user] || 0);
          if (val > 0) {
            const uid = `id_${row['Material']}_${user}`;
            html += `<tr style="border-bottom:1px solid #ddd;">
              <td style="padding:10px;"><strong>${user}</strong></td>
              <td>${row['Material']}</td>
              <td><input type="number" id="${uid}" value="${val}" style="width:60px; text-align:center;"></td>
              <td><button class="btn-used" onclick="handleUsed('${row['Material']}','${user}')">Used</button></td>
            </tr>`;
          }
        });
      });
      tbody.innerHTML = html || '<tr><td colspan="4" style="text-align:center; padding:20px;">No pending materials</td></tr>';
    }

    async function handleUsed(mat, user) {
      const qty = Number(document.getElementById(`id_${mat}_${user}`).value);
      const rec = document.getElementById('sup_reconcile').checked ? 'true' : 'false';
      if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏î‡∏¢‡∏≠‡∏î ${qty} ‡∏´‡∏ô‡πà‡∏ß‡∏¢ ‡∏à‡∏≤‡∏Å ${user}?`)) return;

      const res = await supSetUserQty({ material: mat, user: user, qty: qty, reconcile: rec, status: 'USED' });
      if(res.success) { alert('‡∏ï‡∏±‡∏î‡∏¢‡∏≠‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); await refreshTable(); }
      else { alert('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + res.msg); }
    }

    async function supAddTo0243() {
      const mat = document.getElementById('sup_mat_add').value;
      const qty = document.getElementById('sup_qty_add').value;
      if(!mat || !qty) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');
      
      const res = await supAddStock(mat, qty);
      if(res.success) { 
        alert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Å‡∏•‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); 
        document.getElementById('sup_mat_add').value = '';
        document.getElementById('sup_qty_add').value = '';
        await refreshTable(); 
      } else { alert('‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + res.msg); }
    }
  </script>
</body>
</html>
