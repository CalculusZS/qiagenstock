<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Supervisor Panel</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body onload="initSup()">
  <div class="header-panel" style="background:#1e293b; color:white; padding:15px; display:flex; justify-content:space-between; align-items:center;">
    <b>ðŸ›  Supervisor Control</b>
    <button onclick="location.href='user-select.html'" style="background:none; border:1px solid white; color:white; padding:5px 10px; border-radius:8px; cursor:pointer;">Exit</button>
  </div>

  <div class="container" style="padding:20px; max-width:1100px; margin:auto;">
    <div class="card" style="background:white; padding:20px; border-radius:12px; margin-bottom:20px; box-shadow:0 2px 5px rgba(0,0,0,0.1);">
      <h3 style="margin-top:0;">âž• Add Stock (Column H)</h3>
      <div style="display:flex; gap:10px;">
        <div style="flex:2;">
            <input type="text" id="sup_mat_add" placeholder="Material Code" oninput="showProductName(this.value)" style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd;">
            <div id="display_prod_name" style="margin-top:10px; color:#2563eb; font-weight:bold; font-size:14px; min-height:20px;"></div>
        </div>
        <input type="number" id="sup_qty_add" value="1" style="flex:0.5; padding:10px; border-radius:8px; border:1px solid #ddd; text-align:center;">
        <button onclick="doAdd()" style="background:#2563eb; color:white; border:none; padding:10px 20px; border-radius:8px; font-weight:bold; cursor:pointer;">ADD</button>
      </div>
    </div>

    <div class="card" style="background:white; padding:20px; border-radius:12px; box-shadow:0 2px 5px rgba(0,0,0,0.1);">
      <h3 style="margin:0 0 15px 0;">ðŸ‘¤ Staff Inventory</h3>
      <table style="width:100%; border-collapse:collapse;">
        <thead style="background:#f8fafc;">
          <tr>
            <th style="text-align:left; padding:12px;">Staff</th>
            <th style="text-align:left; padding:12px;">Material</th>
            <th style="text-align:left; padding:12px;">Product Name</th>
            <th style="text-align:center; padding:12px;">Qty</th>
            <th style="text-align:right; padding:12px;">Action</th>
          </tr>
        </thead>
        <tbody id="staff_tbody"></tbody>
      </table>
    </div>
  </div>

  <script src="js/app.js"></script>
  <script>
    async function initSup() {
      if(sessionStorage.getItem('isSupervisor') !== 'true') { location.href='user-select.html'; return; }
      
      // *** à¹à¸à¹‰à¹„à¸‚: à¸•à¹‰à¸­à¸‡à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸•à¹‡à¸­à¸à¸à¹ˆà¸­à¸™à¹€à¸žà¸·à¹ˆà¸­à¹ƒà¸«à¹‰à¸•à¸±à¸§à¹à¸›à¸£ rows à¸¡à¸µà¸„à¹ˆà¸² ***
      const data = await window.loadStockData('all'); 
      if(data) {
          renderStaffTable();
      }
    }

    function showProductName(val) {
        const info = document.getElementById('display_prod_name');
        const item = window.findProductByMat(val);
        if(item) {
            info.innerHTML = "ðŸ“¦ Name: " + item['Product Name'];
        } else {
            info.innerHTML = val ? "ðŸ” Searching..." : "";
        }
    }

    async function renderStaffTable() {
      const usersRes = await window.loadUsers();
      const USERS = usersRes.map(u => u.header);
      const tbody = document.getElementById('staff_tbody');
      
      let html = '';
      rows.forEach(row => {
        USERS.forEach(user => {
          const val = Number(row[user] || 0);
          if (val > 0) {
            const tid = `id_${row.Material}_${user}`;
            html += `<tr style="border-bottom:1px solid #eee;">
              <td style="padding:12px;"><span style="background:#eff6ff; color:#2563eb; padding:4px 8px; border-radius:15px; font-size:12px; font-weight:bold;">${user}</span></td>
              <td style="padding:12px; font-weight:bold;">${row.Material}</td>
              <td style="padding:12px; font-size:12px;">${row['Product Name'] || ''}</td>
              <td style="text-align:center;"><input type="number" id="${tid}" value="${val}" style="width:50px; text-align:center;"></td>
              <td style="text-align:right; padding:12px;">
                <button onclick="doDeduct('${row.Material}','${user}','${tid}')" style="background:#ef4444; color:white; border:none; padding:8px 12px; border-radius:8px; cursor:pointer;">Deduct</button>
              </td></tr>`;
          }
        });
      });
      tbody.innerHTML = html || '<tr><td colspan="5" style="text-align:center; padding:20px;">No staff stock found</td></tr>';
    }

    async function doAdd() {
        const mat = document.getElementById('sup_mat_add').value;
        const qty = document.getElementById('sup_qty_add').value;
        if(!mat) return alert("Please enter Material");
        const res = await window.supAddStock(mat, qty);
        if(res.success) { alert("Updated!"); location.reload(); }
    }

    async function doDeduct(mat, user, tid) {
        const qty = document.getElementById(tid).value;
        if(!confirm(`Deduct ${qty} units from ${user}?`)) return;
        const res = await window.supDeductUser(mat, user, qty);
        if(res.success) { alert("Success!"); location.reload(); }
    }
  </script>
</body>
</html>
