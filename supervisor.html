<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Supervisor Panel</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body onload="initSup()">
  <div class="header-panel" style="background:#1e293b; color:white; padding:15px; display:flex; justify-content:space-between;">
    <b>ðŸ›  Admin Console</b>
    <button onclick="location.href='user-select.html'" style="color:white; background:none; border:1px solid white; border-radius:5px;">Exit</button>
  </div>

  <div class="container" style="padding:20px;">
    <div class="card" style="background:white; padding:20px; border-radius:10px; margin-bottom:20px; border:1px solid #ddd;">
      <h3>âž• Add Stock (0243)</h3>
      <div style="display:flex; gap:10px;">
        <input type="text" id="s_mat" placeholder="Material Code" oninput="showPName(this.value)" style="flex:2; padding:10px;">
        <input type="number" id="s_qty" value="1" style="flex:0.5; padding:10px; text-align:center;">
        <button onclick="doAdd()" style="background:#2563eb; color:white; border:none; padding:10px 20px; border-radius:5px;">ADD</button>
      </div>
      <div id="p_name_display" style="margin-top:10px; color:#2563eb; font-weight:bold;"></div>
    </div>

    <div class="card" style="background:white; padding:20px; border-radius:10px; border:1px solid #ddd;">
      <h3>ðŸ‘¤ Staff Inventory</h3>
      <table style="width:100%; border-collapse:collapse;">
        <thead>
          <tr style="border-bottom:2px solid #eee;">
            <th style="text-align:left; padding:10px;">Staff</th>
            <th style="text-align:left; padding:10px;">Material</th>
            <th style="text-align:center; padding:10px;">Qty</th>
            <th style="text-align:right; padding:10px;">Action</th>
          </tr>
        </thead>
        <tbody id="staff_tbody"></tbody>
      </table>
    </div>
  </div>

  <script src="js/app.js"></script>
  <script>
    async function initSup() {
      if(sessionStorage.getItem('isSupervisor') !== 'true') { location.href='user-select.html'; return; }
      
      // à¸”à¸¶à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸•à¹‡à¸­à¸à¸¥à¸‡à¸•à¸±à¸§à¹à¸›à¸£ rows à¸à¹ˆà¸­à¸™
      await window.loadStockData('all'); 
      renderStaffTable();
    }

    function showPName(val) {
      const display = document.getElementById('p_name_display');
      const item = window.findProductByMat(val);
      display.innerHTML = item ? "ðŸ“¦ " + item['Product Name'] : (val ? "ðŸ” Searching..." : "");
    }

    async function renderStaffTable() {
      const users = await window.loadUsers();
      const USERS = users.map(u => u.header);
      const tbody = document.getElementById('staff_tbody');
      let html = '';
      
      rows.forEach(row => {
        USERS.forEach(user => {
          const val = Number(row[user] || 0);
          if (val > 0) {
            const tid = `id_${row.Material}_${user}`;
            html += `<tr style="border-bottom:1px solid #eee;">
              <td style="padding:10px;">${user}</td>
              <td style="padding:10px;"><b>${row.Material}</b><br><small>${row['Product Name']}</small></td>
              <td style="text-align:center;"><input type="number" id="${tid}" value="${val}" style="width:40px; text-align:center;"></td>
              <td style="text-align:right; padding:10px;"><button onclick="doDeduct('${row.Material}','${user}','${tid}')" style="background:red; color:white; border:none; border-radius:5px; padding:5px 10px;">Deduct</button></td>
            </tr>`;
          }
        });
      });
      tbody.innerHTML = html || '<tr><td colspan="4" style="text-align:center; padding:20px;">No staff stock.</td></tr>';
    }

    async function doAdd() {
      const res = await window.supAddStock(document.getElementById('s_mat').value, document.getElementById('s_qty').value);
      if(res.success) { alert("Success!"); location.reload(); }
    }

    async function doDeduct(mat, user, tid) {
      if(!confirm("Deduct from user?")) return;
      const res = await window.supDeductUser(mat, user, document.getElementById(tid).value);
      if(res.success) { alert("Deducted!"); location.reload(); }
    }
  </script>
</body>
</html>
