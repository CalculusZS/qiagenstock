<script>
    const USERS = ['Kitti','Tatchai','Parinyachat','Phurilap','Penporn','Phuriwat'];

    async function onSupLoad() { 
        await window.loadStockData('all'); // โหลดข้อมูลล่าสุด
    }

    // ฟังก์ชันค้นหาชื่อสินค้าอัตโนมัติ (เพิ่มตามคำขอเดิม)
    function lookupMat(val) {
        const product = window.findProductByMaterial(val);
        const div = document.getElementById('display_prod_name');
        if (product) {
            div.textContent = "Product: " + product['Product Name'];
            div.style.color = "#2563eb";
        } else {
            div.textContent = "Product: Not found";
            div.style.color = "#ef4444";
        }
    }

    // ฟังก์ชันสร้างตาราง Person Stock Inspector
    function refreshTable() {
        const tbody = document.getElementById('sup_users_table_body');
        let html = '';
        
        rows.forEach(row => {
            USERS.forEach(name => {
                const qty = Number(row[name] || 0);
                if (qty > 0) {
                    const inputId = `id_${row.Material}_${name}`; // ID สำหรับดึงค่าจากช่องกรอก
                    html += `<tr>
                        <td><span class="user-pill">${name}</span></td>
                        <td style="font-weight:700;">${row.Material}</td>
                        <td style="color:#475569; font-size:14px;">${row['Product Name'] || ''}</td>
                        <td><input type="number" class="qty-input" id="${inputId}" value="${qty}"></td>
                        <td><button class="btn-deduct" onclick="handleDeductUsed('${row.Material}','${name}','${inputId}')">Deduct Used</button></td>
                    </tr>`;
                }
            });
        });
        tbody.innerHTML = html || '<tr><td colspan="5" style="text-align:center; padding:30px;">No one is currently holding stock.</td></tr>';
    }

    // ฟังก์ชันกด Deduct Used (ลบจำนวนออกตามที่กรอก และ Log เป็น Supervisor)
    async function handleDeductUsed(mat, userName, inputId) {
        const qtyToDeduct = document.getElementById(inputId).value; // ดึงค่าจากช่องกรอก
        
        if (!confirm(`Confirm deduction of ${qtyToDeduct} unit(s) from ${userName}? (Logged as Supervisor)`)) return;

        // เรียกฟังก์ชันใน app.js ที่เตรียมไว้
        const res = await window.supDeductUser(mat, userName, qtyToDeduct);

        if(res.success) {
            alert('ตัดยอดออกจากระบบสำเร็จ!');
            await window.loadStockData('all'); // โหลดข้อมูลใหม่เพื่อรีเฟรชตาราง
        } else {
            alert('Error: ' + res.msg);
        }
    }
</script>
