
// --- HOTFIX: ตั้งผู้ใช้ดีฟอลต์ + ปิด overlay + ไปหน้า "เบิกอะไหล่" ทันที
(() => {
  const DEFAULT_USER = "PK";
  // เซ็ตผู้ใช้ดีฟอลต์แบบ global (ถ้าตัวแปรประกาศในสโคปบนสุดจะกลายเป็น window.currentUser)
  try { window.currentUser = DEFAULT_USER; } catch(e) {}
  // อัปเดต badge ผู้ใช้
  const span = document.querySelector('#currentUser');
  if (span) span.textContent = DEFAULT_USER;
  // ปิด overlay ถ้าบังอยู่
  const overlay = document.querySelector('#userOverlay');
  if (overlay) overlay.style.display = 'none';
  // พาไปหน้าเบิกอะไหล่
  const issueBtn = document.querySelector('#goIssue');
  if (issueBtn) issueBtn.click();
  // สำรอง: เรียกฟังก์ชันสลับหน้าโดยตรง (ถ้าโปรเจ็กต์มีฟังก์ชัน showSection)
  if (typeof showSection === 'function') showSection('issueSection');
})();

<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>ระบบเบิก/คืนอะไหล่ (อ้างอิงจาก CSV)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --pri:#0078d4; --bg:#f7f7fb; --border:#e1e1e8; --text:#222; }
    *{box-sizing:border-box}
    body { font-family: system-ui,Segoe UI,Roboto,Arial,sans-serif; margin:0; color:var(--text); background:var(--bg);}
    header { background:#fff; border-bottom:1px solid var(--border); padding:16px 20px; display:flex; justify-content:space-between; align-items:center;}
    header h1 { margin:0; font-size:18px;}
    .user-badge { font-size:13px; color:#333; cursor:pointer; }
    .user-badge .chip { display:inline-block; padding:4px 10px; border-radius:999px; border:1px solid var(--border); background:#fff; margin-left:6px; }

    .container { max-width:1100px; margin: 20px auto; background:#fff; border:1px solid var(--border); border-radius:10px; padding:20px;}
    .home { text-align:center; padding:60px 20px;}
    .btn { display:inline-block; padding:12px 18px; border-radius:8px; border:1px solid var(--pri); color:#fff; background:var(--pri); cursor:pointer; text-decoration:none; }
    .btn.ghost { background:#fff; color:var(--pri); }
    .btn.warn { background:#b30000; border-color:#b30000; }
    .btn.small { padding:8px 12px; font-size:14px; }
    .btn + .btn { margin-left:12px; }
    .row { display:flex; gap:16px; flex-wrap:wrap; }
    .col-6 { flex:1 1 300px; }
    label { display:block; margin-top:12px; font-weight:600; }
    input, select, textarea { width:100%; padding:10px; margin-top:6px; border:1px solid var(--border); border-radius:6px; background:#fff; }
    textarea { resize:vertical; }
    h2 { margin:0 0 6px 0;}
    .muted { color:#666; font-size:13px; }
    table { width:100%; border-collapse:collapse; margin-top:16px; }
    th, td { border:1px solid var(--border); padding:10px; vertical-align:top;}
    th { background:#fafafa; text-align:left;}
    .actions { display:flex; gap:8px; margin-top:16px; flex-wrap:wrap; }
    .toolbar { display:flex; justify-content:space-between; align-items:center; margin-top:6px;}
    .backlink { color:var(--pri); cursor:pointer; text-decoration:none; }
    .chip { display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid var(--border); background:#fff; color:#333; }
    .section { margin-top:10px; padding-top:10px; border-top:1px dashed var(--border); }
    .hidden { display:none; }
    .footer-note { color:#666; font-size:12px; margin-top:10px; }

    /* Overlay เลือกผู้ใช้ */
    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5);
      display:flex; align-items:center; justify-content:center; z-index: 1000; }
    .overlay-card {
      width: min(560px, 92vw);
      background: #fff; border-radius: 12px; border: 1px solid var(--border);
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      padding: 20px;
      text-align:center;
    }
    .user-grid { display:grid; grid-template-columns: repeat(3, 1fr); gap:12px; margin-top:16px; }
    .user-btn {
      padding:14px 10px; border-radius:10px; border:1px solid var(--border);
      background:#fff; cursor:pointer; font-weight:700; font-size:16px;
    }
    .user-btn:hover { border-color: var(--pri); color: var(--pri); }

    /* Modal ค้นหา Material */
    .modal { position: fixed; inset:0; display:none; align-items: center; justify-content: center; z-index: 1100;
      background: rgba(0,0,0,0.4); }
    .modal .card { width: min(1000px, 95vw); background:#fff; border:1px solid var(--border); border-radius:12px; padding:16px;
      max-height: 90vh; overflow:auto; }
    .modal .header { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
    .modal .close { cursor:pointer; color:#555; }
    .hint { font-size:12px; color:#666; }
  </style>
</head>
<body>
<header>
  <h1>ระบบเบิก/คืนอะไหล่</h1>
  <div class="user-badge" title="คลิกเพื่อเปลี่ยนผู้ใช้">
    ผู้ใช้งาน: <span id="currentUser" class="chip">ยังไม่เลือก</span>
  </div>
</header>

<!-- เลือกผู้ใช้งาน -->
<div id="userOverlay" class="overlay">
  <div class="overlay-card">
    <h2>เลือกผู้ใช้งาน</h2>
    <p class="muted">กรุณาเลือกรหัสผู้ใช้เพื่อเริ่มต้น</p>
    <div class="user-grid">
      <button class="user-btn" data-user="KM">KM</button>
      <button class="user-btn" data-user="TK">TK</button>
      <button class="user-btn" data-user="PSO">PSO</button>
      <button class="user-btn" data-user="PST">PST</button>
      <button class="user-btn" data-user="PK">PK</button>
      <button class="user-btn" data-user="PA">PA</button>
    </div>
    <p class="hint">* จะไม่สามารถ “ยืนยันการเบิก” ได้หากยังไม่เลือกผู้ใช้งาน</p>
  </div>
</div>

<!-- Modal ค้นหา Material -->
<div id="materialModal" class="modal">
  <div class="card">
    <div class="header">
      <h3 style="margin:0">ค้นหา Material</h3>
      <span id="modalClose" class="close">✕</span>
    </div>
    <div class="row">
      <div class="col-6">
        <label>ค้นหา</label>
        <input type="text" id="mat_search" placeholder="พิมพ์รหัส/ชื่อ/รุ่น เพื่อค้นหา..." />
        <p class="hint">จะแสดงคอลัมน์: Name + A1, B1, C1, D1, H1</p>
      </div>
      <div class="col-6">
        <label>ผลลัพธ์</label>
        <div><span id="mat_count" class="chip">0 รายการ</span></div>
      </div>
    </div>
    <table>
      <thead>
        <tr id="mat_header_row"></tr>
      </thead>
      <tbody id="mat_tbody"></tbody>
    </table>
  </div>
</div>

<div class="container">
  <!-- HOME -->
  <section id="homeSection" class="home">
    <h2>ยินดีต้อนรับ</h2>
    <p class="muted">เลือกการทำรายการที่ต้องการ</p>
    <div style="margin-top:24px;">
      <a class="btn" id="goIssue">เบิกอะไหล่</a>
      <a class="btn ghost" id="goReturn">คืนอะไหล่</a>
    </div>
  </section>

  <!-- ISSUE FORM -->
  <section id="issueSection" class="hidden">
    <div class="toolbar">
      <a class="backlink" data-back>← กลับหน้าแรก</a>
      <span class="chip">โหมด: เบิกอะไหล่</span>
    </div>
    <h2>แบบฟอร์มเบิกอะไหล่</h2>
    <p class="muted">กรอกข้อมูลผู้ขอและเลือกอะไหล่จากรายการ</p>

    <div class="actions">
      <button class="btn" id="openMatSearch_issue">ค้นหา Material</button>
    </div>

    <div class="row">
      <div class="col-6">
        <label>ผู้ขอเบิก</label>
        <input type="text" id="issue_requester" placeholder="เช่น Phurilap Khonthong" />
      </div>
      <div class="col-6">
        <label>หน่วยงาน/ทีม</label>
        <input type="text" id="issue_team" placeholder="เช่น TH Service Team" />
      </div>
      <div class="col-6">
        <label>เหตุผลการเบิก</label>
        <textarea id="issue_reason" rows="3" placeholder="เช่น PM / CM / Demo / Warranty / Internal Use"></textarea>
      </div>
      <div class="col-6">
        <label>Cost Center / Project / Order (ถ้ามี)</label>
        <input type="text" id="issue_costCenter" />
      </div>
      <div class="col-6">
        <label>ลูกค้า / Serial No. (ถ้ามี)</label>
        <input type="text" id="issue_customer" placeholder="เช่น Customer ABC / SN-123456" />
      </div>
      <div class="col-6">
        <label>วันที่ต้องการ</label>
        <input type="date" id="issue_needDate" />
      </div>
    </div>

    <div class="section">
      <h3>เลือกอะไหล่</h3>
      <div class="row">
        <div class="col-6">
          <label>ค้นหาอะไหล่</label>
          <input type="text" id="issue_search" placeholder="พิมพ์ชื่อ/รหัส/รุ่น เพื่อค้นหา..." />
