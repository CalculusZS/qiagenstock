<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>ระบบเบิก-คืนอะไหล่</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .hidden { display: none; }
    button { margin: 5px; padding: 8px 14px; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
    th { background: #f2f2f2; }
    input { padding: 6px; margin: 4px 0; }
  </style>
</head>
<body>

<h2 id="title">เลือกผู้ใช้งาน</h2>

<!-- หน้าเลือกผู้ใช้งาน -->
<div id="userPage">
  <button onclick="selectUser('KM')">KM</button>
  <button onclick="selectUser('TK')">TK</button>
  <button onclick="selectUser('PST')">PST</button>
  <button onclick="selectUser('PSO')">PSO</button>
  <button onclick="selectUser('PK')">PK</button>
  <button onclick="selectUser('PA')">PA</button>
</div>

<!-- หน้าเมนู -->
<div id="menuPage" class="hidden">
  <p>ผู้ใช้งาน: <strong id="currentUser"></strong></p>
  <button onclick="openIssue()">เบิกอะไหล่</button>
  <button onclick="openReturn()">คืนอะไหล่</button>
</div>

<!-- หน้าเบิก / คืน -->
<div id="actionPage" class="hidden">
  <h3 id="actionTitle"></h3>
  <input type="text" id="search" placeholder="ค้นหา Material" />
  <button onclick="searchMaterial()">ค้นหา</button>

  <table id="resultTable" class="hidden">
    <thead>
      <tr>
        <th>A</th><th>B</th><th>C</th><th>H</th><th>จำนวน (ea)</th><th>ยืนยัน</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <button onclick="backMenu()">ย้อนกลับ</button>
</div>

<!-- Log -->
<div id="logPage">
  <h3>Log การทำรายการ</h3>
  <table>
    <thead>
      <tr><th>เวลา</th><th>ผู้ใช้</th><th>ประเภท</th><th>Material</th><th>จำนวน</th></tr>
    </thead>
    <tbody id="logBody"></tbody>
  </table>
</div>

<script>
const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQg2ma13Gm9ppdtEaZAb9fLuZn2YmoXFJx3DYb5te4Fua4xej_OFU-_6J6OQBXXdO8AAWlueRQ1omHd/pub?output=csv';
let csvData = [];
let currentUser = '';
let currentAction = '';

fetch(csvUrl)
  .then(res => res.text())
  .then(text => {
    const rows = text.split('\n').map(r => r.split(','));
    csvData = rows.slice(1); // ตัด header
  });

function selectUser(u) {
  currentUser = u;
  document.getElementById('currentUser').innerText = u;
  document.getElementById('userPage').classList.add('hidden');
  document.getElementById('menuPage').classList.remove('hidden');
}

function openIssue() {
  openAction('เบิกอะไหล่');
}

function openReturn() {
  openAction('คืนอะไหล่');
}

function openAction(type) {
  currentAction = type;
  document.getElementById('menuPage').classList.add('hidden');
  document.getElementById('actionPage').classList.remove('hidden');
  document.getElementById('actionTitle').innerText = type;
}

function backMenu() {
  document.getElementById('actionPage').classList.add('hidden');
  document.getElementById('menuPage').classList.remove('hidden');
}

function searchMaterial() {
  const q = document.getElementById('search').value.toLowerCase();
  const tbody = document.querySelector('#resultTable tbody');
  tbody.innerHTML = '';

  csvData.filter(r => r[0].toLowerCase().includes(q)).forEach(r => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r[0]}</td>
      <td>${r[1]}</td>
      <td>${r[2]}</td>
      <td>${r[7]}</td>
      <td><input type="number" min="1" /></td>
      <td><button onclick="confirmAction(this,'${r[0]}')">ตกลง</button></td>
    `;
    tbody.appendChild(tr);
  });

  document.getElementById('resultTable').classList.remove('hidden');
}

function confirmAction(btn, material) {
  const qty = btn.parentElement.parentElement.querySelector('input').value;
  if (!qty) return alert('กรุณาใส่จำนวน');

  const log = document.createElement('tr');
  log.innerHTML = `
    <td>${new Date().toLocaleString()}</td>
    <td>${currentUser}</td>
    <td>${currentAction}</td>
    <td>${material}</td>
    <td>${qty}</td>
  `;
  document.getElementById('logBody').appendChild(log);
  alert('บันทึกเรียบร้อย');
}
</script>

</body>
</html>
