
<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ระบบเบิก/คืนอะไหล่ - QIAGEN</title>
  <style>
    :root {
      --primary:#2563eb; --border:#e5e7eb; --muted:#6b7280; --bg:#f8fafc;
      --ok:#065f46; --err:#991b1b;
    }
    body { font-family: "Segoe UI", Tahoma, sans-serif; margin: 20px; color:#111; background:var(--bg); }
    h1,h2 { margin:0 0 8px 0 }
    .card { background:#fff; border:1px solid var(--border); border-radius:12px; padding:16px; margin-bottom:16px; }
    .row { display:flex; flex-wrap:wrap; align-items:center; gap:10px }
    .btn { padding:10px 16px; border-radius:10px; border:1px solid var(--primary); background:var(--primary); color:#fff; cursor:pointer; }
    .btn.secondary { background:#fff; color:var(--primary); }
    .btn:disabled { opacity:.6; cursor:not-allowed }
    input[type="text"], input[type="number"] { border:1px solid #cbd5e1; border-radius:10px; padding:8px 10px; }
    table { width:100%; border-collapse:collapse; margin-top:12px; }
    th,td { border:1px solid var(--border); padding:8px; text-align:left; }
    th { background:#f1f5f9 }
    small.muted { color:var(--muted) }
    .pill { display:inline-block; padding:4px 10px; border-radius:999px; background:#eef2ff; border:1px solid #c7d2fe; }
    #status.ok { color:var(--ok) }  #status.err { color:var(--err) }  #status { color:var(--muted) }
  </style>
</head>
<body>
  <h1>ระบบเบิก/คืนอะไหล่</h1>

  <div class="card">
    <h2>เลือกผู้ใช้งาน</h2>
    <div id="userButtons" class="row"><small class="muted">กำลังโหลดรายชื่อ...</small></div>
    <div><small class="muted">ผู้ใช้งานปัจจุบัน: <span id="currentUser" class="pill">ยังไม่เลือก</span></small></div>
  </div>

  <div class="card">
    <h2>เลือกการทำรายการ</h2>
    <div class="row">
      <button class="btn" id="btnWithdraw" disabled>เบิกอะไหล่</button>
      <button class="btn secondary" id="btnReturn" disabled>คืนอะไหล่</button>
    </div>
    <div><small class="muted">สถานะ: <span id="currentAction" class="pill">ยังไม่เลือก</span></small></div>
  </div>

  <div class="card">
    <h2>ค้นหาอะไหล่ (Material - คอลัมน์ A)</h2>
    <div class="row">
      <input type="text" id="searchInput" placeholder="พิมพ์รหัสหรือคำค้น แล้วกด Enter/ปุ่มค้นหา" style="min-width:260px" />
      <button class="btn" id="btnSearch">ค้นหา</button>
      <small class="muted">จะแสดง A, B, C, H เท่านั้น</small>
    </div>
    <div id="status" style="margin-top:8px"></div>
    <div id="results"></div>
  </div>

  <script>
    // ==== ตั้งค่าเฉพาะจุดนี้ (ใช้ URL Web App /exec ของคุณ) ====
    const API_BASE = 'https://script.google.com/macros/s/AKfycbyegzrutyW7bF2ygaw2uJxjjU7kWyOuNGAXGP8gdvT4B3-iybc5XDYc8dPSv63wV5SOpg/exec';

    let ALL_DATA = [];       // รายการอะไหล่ทั้งหมด (A,B,C,H)
    let CURRENT_USER = '';   // KM/TK/PST/PSO/PK/PA
    let CURRENT_ACTION = ''; // 'Withdraw' | 'Return'

    // ---------- Utils ----------
    const qs = sel => document.querySelector(sel);
    function setStatus(msg, type='info') {
      const el = qs('#status');
      el.className = type === 'ok' ? 'ok' : type === 'err' ? 'err' : '';
      el.textContent = msg || '';
    }
    function createEl(tag, opts={}) {
      const el = document.createElement(tag);
      if (opts.className) el.className = opts.className;
      if (opts.text) el.textContent = opts.text;
      if (opts.html) el.innerHTML = opts.html;
      return el;
    }

    // ---------- API ----------
    async function apiGet(action) {
      const url = `${API_BASE}?action=${encodeURIComponent(action)}`;
      const res = await fetch(url, { method:'GET' });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json();
    }
    async function apiPost(payload) {
      const res = await fetch(API_BASE, {
        method:'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify(payload)
      });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json();
    }

    // ---------- App Logic ----------
    async function init() {
      try {
        // โหลดผู้ใช้
        const u = await apiGet('users');
        renderUsers(u.users || []);
        // โหลดข้อมูลอะไหล่
        const d = await apiGet('parts');
        ALL_DATA = (d && d.rows) ? d.rows : [];
        setStatus(`โหลดข้อมูลแล้ว ${ALL_DATA.length.toLocaleString()} รายการ`);
      } catch (err) {
        setStatus(`โหลดข้อมูลล้มเหลว: ${err.message || err}`, 'err');
      }

      // Events
      qs('#btnSearch').addEventListener('click', onSearch);
      qs('#searchInput').addEventListener('keyup', e => { if (e.key === 'Enter') onSearch(); });
      qs('#btnWithdraw').addEventListener('click', () => setAction('Withdraw'));
      qs('#btnReturn').addEventListener('click', () => setAction('Return'));
    }

    function renderUsers(users) {
      const holder = qs('#userButtons');
      holder.innerHTML = '';
      if (!users.length) {
        holder.innerHTML = '<small class="muted">ไม่พบรายชื่อผู้ใช้งาน</small>';
        return;
      }
      users.forEach(u => {
        const b = createEl('button', { className:'btn secondary', text:u });
        b.onclick = () => chooseUser(u);
        holder.appendChild(b);
      });
    }

    function chooseUser(u) {
      CURRENT_USER = u;
      qs('#currentUser').textContent = u;
      qs('#btnWithdraw').disabled = false;
      qs('#btnReturn').disabled = false;
      setStatus(`เลือกผู้ใช้งาน: ${u}`);
    }

    function setAction(a) {
      CURRENT_ACTION = a;
      qs('#currentAction').textContent = (a === 'Withdraw') ? 'เบิกอะไหล่' : 'คืนอะไหล่';
      setStatus(`โหมด: ${(a==='Withdraw')?'เบิกอะไหล่':'คืนอะไหล่'} พร้อมค้นหาได้เลย`);
    }

    function onSearch() {
      const q = (qs('#searchInput').value || '').trim().toLowerCase();
      if (!q) {
        renderTable([]);
        setStatus('กรุณาพิมพ์คำค้น (อย่างน้อย 1 ตัวอักษร)');
        return;
      }
      if (!CURRENT_USER) { setStatus('กรุณาเลือกผู้ใช้งานก่อน', 'err'); return; }
      if (!CURRENT_ACTION) { setStatus('กรุณาเลือกประเภทการทำรายการก่อน', 'err'); return; }

      const results = ALL_DATA.filter(r => {
        const a = (r.A ?? '').toString().toLowerCase();
        const b = (r.B ?? '').toString().toLowerCase();
        return a.includes(q) || b.includes(q); // ค้น A+B
      });
      renderTable(results);
      setStatus(`พบ ${results.length.toLocaleString()} รายการสำหรับ "${q}"`);
    }

    function renderTable(rows) {
      const container = qs('#results');
      if (!rows.length) { container.innerHTML = '<small class="muted">ไม่มีผลลัพธ์</small>'; return; }

      const table = createEl('table');
      const thead = createEl('thead'); thead.innerHTML = `
        <tr>
          <th>A (Material)</th>
          <th>B</th>
          <th>C</th>
          <th>H</th>
          <th>จำนวน (ea)</th>
          <th>ยืนยัน</th>
        </tr>`;
      table.appendChild(thead);

      const tbody = createEl('tbody');
      rows.forEach((r, idx) => {
        const tr = createEl('tr');
        const tdA = createEl('td', { text: r.A ?? '' });
        const tdB = createEl('td', { text: r.B ?? '' });
        const tdC = createEl('td', { text: r.C ?? '' });
        const tdH = createEl('td', { text: r.H ?? '' });

        const qtyTd = createEl('td');
        const qtyInput = createEl('input'); qtyInput.type = 'number'; qtyInput.min = '1'; qtyInput.placeholder = 'ea'; qtyInput.style.width = '100px';
        qtyInput.id = `qty_${idx}`; qtyTd.appendChild(qtyInput);

        const btnTd = createEl('td');
        const btn = createEl('button', { className:'btn', text:'ยืนยัน' });
        btn.onclick = () => submitLog({ A:r.A, B:r.B, C:r.C, H:r.H, qtyElId: qtyInput.id });
        btnTd.appendChild(btn);

        [tdA, tdB, tdC, tdH, qtyTd, btnTd].forEach(td => tr.appendChild(td));
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);

      container.innerHTML = '';
      container.appendChild(table);
    }

    async function submitLog({ A, B, C, H, qtyElId }) {
      const qty = Number((document.getElementById(qtyElId).value || '0'));
      if (!CURRENT_USER) { setStatus('กรุณาเลือกผู้ใช้งานก่อน', 'err'); return; }
      if (!CURRENT_ACTION) { setStatus('กรุณาเลือกประเภทการทำรายการก่อน', 'err'); return; }
      if (!A) { setStatus('ข้อมูล Material (A) ว่าง', 'err'); return; }
      if (!(qty > 0)) { setStatus('กรุณากรอกจำนวน (ea) มากกว่า 0', 'err'); return; }

      setStatus('กำลังบันทึก...');
      try {
        const res = await apiPost({
          user: CURRENT_USER,
          action: CURRENT_ACTION, // 'Withdraw' | 'Return'
          A, B, C, H, qty
        });
        if (res && res.ok) {
          setStatus('บันทึกสำเร็จ', 'ok');
        } else {
          setStatus(res.message || 'บันทึกล้มเหลว', 'err');
        }
      } catch (err) {
        setStatus(`ผิดพลาด: ${err.message || err}`, 'err');
      }
    }

    // Go!
    init();
  </script>
</body>
</html>
