
<!DOCTYPE html>
<html lang=\"th\">
<head>
  <meta charset=\"utf-8\" />
  <title>Inventory Web App</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .row { margin-bottom: 12px; }
    input, select, button { padding: 6px; font-size: 14px; }
    table { border-collapse: collapse; width: 100%; margin-top: 12px; }
    th, td { border: 1px solid #ddd; padding: 8px; }
    th { background: #f5f5f5; }
    .actions { display: flex; gap: 6px; }
    .badge { display: inline-block; padding: 2px 6px; background: #eee; border-radius: 4px; }
  </style>
</head>
<body>
  <h2>ระบบเบิก/รับเข้าอะไหล่ (จาก Excel)</h2>
  <div class=\"row\">
    <label>ค้นหาจาก <strong>Material#</strong>: </label>
    <input type=\"text\" id=\"materialInput\" placeholder=\"เช่น 9026556\" />
    <label style=\"margin-left:10px;\">หรือ <strong>Instrument</strong>: </label>
    <input type=\"text\" id=\"instrumentInput\" placeholder=\"เช่น QIAStat Dx\" />
    <button id=\"searchBtn\">ค้นหา</button>
    <button id=\"showAllBtn\">แสดงข้อมูลทั้งหมด</button>
  </div>
  <div class=\"row\">
    <label>ผู้เบิก: </label>
    <select id=\"issuerSelect\"></select>
    <span class=\"badge\" id=\"issuerHint\">อ้างอิงรายชื่อจากคอลัมน์ I5–N5</span>
  </div>
  <table id=\"resultTable\">
    <thead>
      <tr>
        <th>Instrument</th>
        <th>Material#</th>
        <th>Product Name</th>
        <th>Type</th>
        <th>Min Qty</th>
        <th>Stock Qty</th>
        <th>Need To Order</th>
        <th>เบิกออก</th>
        <th>รับเข้า</th>
        <th>บันทึก</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class=\"row\">
    <button id=\"exportJsonBtn\">ดาวน์โหลด JSON ที่อัพเดทแล้ว</button>
    <button id=\"exportTxBtn\">ดาวน์โหลดรายการเคลื่อนไหว (CSV)</button>
    <button id=\"resetBtn\" style=\"margin-left:10px;\">รีเซ็ตข้อมูลหน้านี้</button>
  </div>

<script>
let data = {};
let items = [];
let issuers = [];
let transactions = []; // {date, issuer, material, instrument, issueQty, receiveQty, stockAfter}

function loadFromLocal() {
  try {
    const itemsStr = localStorage.getItem('inv_items');
    const txStr = localStorage.getItem('inv_transactions');
    if (itemsStr) items = JSON.parse(itemsStr);
    if (txStr) transactions = JSON.parse(txStr);
  } catch(e) { console.warn('localStorage parse error', e); }
}

function saveToLocal() {
  try {
    localStorage.setItem('inv_items', JSON.stringify(items));
    localStorage.setItem('inv_transactions', JSON.stringify(transactions));
  } catch(e) { console.warn('localStorage save error', e); }
}

function loadData() {
  loadFromLocal();
  fetch('inventory.json')
    .then(r => r.json())
    .then(j => {
      data = j;
      issuers = j.issuers || [];
      if (!items || items.length === 0) {
        items = j.items || [];
      }
      const sel = document.getElementById('issuerSelect');
      sel.innerHTML = issuers.map(u => `<option value=\"${u}\">${u}</option>`).join('');
      showAll();
    })
    .catch(err => {
      alert('ไม่พบไฟล์ inventory.json');
      console.error(err);
      // still render with whatever exists
      showAll();
    });
}

function renderRows(list) {
  const tb = document.querySelector('#resultTable tbody');
  tb.innerHTML = '';
  list.forEach((it, idx) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${it['Instrument']}</td>
      <td>${it['Material#']}</td>
      <td>${it['Product Name']}</td>
      <td>${it['Type']}</td>
      <td>${it['MinimumQty'] ?? ''}</td>
      <td>${it['StockQty'] ?? ''}</td>
      <td>${it['NeedToOrder'] ?? ''}</td>
      <td><input type=\"number\" min=\"0\" step=\"1\" id=\"issue_${idx}\" placeholder=\"0\"></td>
      <td><input type=\"number\" min=\"0\" step=\"1\" id=\"recv_${idx}\" placeholder=\"0\"></td>
      <td class=\"actions\"><button onclick=\"saveRow(${idx})\">บันทึก</button></td>
    `;
    tb.appendChild(tr);
  });
}

function showAll() {
  renderRows(items);
}

function search() {
  const m = document.getElementById('materialInput').value.trim();
  const inst = document.getElementById('instrumentInput').value.trim().toLowerCase();
  const filtered = items.filter(it => {
    const okM = m ? (it['Material#'].includes(m)) : true;
    const okI = inst ? (it['Instrument'].toLowerCase().includes(inst)) : true;
    return okM && okI;
  });
  renderRows(filtered);
}

function saveRow(idx) {
  const issue = parseFloat(document.getElementById('issue_'+idx).value || '0');
  const recv = parseFloat(document.getElementById('recv_'+idx).value || '0');
  if (isNaN(issue) || isNaN(recv)) { alert('จำนวนไม่ถูกต้อง'); return; }
  const issuer = document.getElementById('issuerSelect').value;
  const it = items[idx];
  const current = parseFloat(it['StockQty'] || '0');
  const after = current - issue + recv;
  it['StockQty'] = after;

  // Log transaction
  const tx = {
    date: new Date().toISOString(),
    issuer: issuer,
    material: it['Material#'],
    instrument: it['Instrument'],
    issueQty: issue,
    receiveQty: recv,
    stockAfter: after
  };
  transactions.push(tx);
  saveToLocal();
  alert('บันทึกเรียบร้อย');
  showAll();
}

function exportJson() {
  const blob = new Blob([JSON.stringify({issuers, items}, null, 2)], {type: 'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'inventory_updated.json';
  a.click();
}

function exportTx() {
  const header = ['date','issuer','material','instrument','issueQty','receiveQty','stockAfter'];
  const rows = transactions.map(t => header.map(h => t[h]));
  const csv = [header.join(','), ...rows.map(r => r.join(','))].join('\n');
  const blob = new Blob([csv], {type: 'text/csv'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'transactions.csv';
  a.click();
}

function resetData() {
  if (confirm('ต้องการรีเซ็ตข้อมูลจาก localStorage หรือไม่?')) {
    localStorage.removeItem('inv_items');
    localStorage.removeItem('inv_transactions');
    transactions = [];
    // reload original data from inventory.json
    loadData();
  }
}

document.getElementById('searchBtn').addEventListener('click', search);

document.getElementById('showAllBtn').addEventListener('click', showAll);

document.getElementById('exportJsonBtn').addEventListener('click', exportJson);

document.getElementById('exportTxBtn').addEventListener('click', exportTx);

document.getElementById('resetBtn').addEventListener('click', resetData);

loadData();
</script>
</body>
</html>
