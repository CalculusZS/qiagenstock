<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ระบบเบิกอะไหล่</title>

<style>
body {
  font-family: Arial, sans-serif;
  margin: 10px;
  background: #f4f6f8;
}

.card {
  background: #fff;
  border-radius: 10px;
  padding: 15px;
  margin-bottom: 12px;
  box-shadow: 0 2px 6px rgba(0,0,0,.1);
}

input, select, button {
  width: 100%;
  padding: 10px;
  margin: 5px 0;
  font-size: 16px;
}

button {
  background: #007bff;
  color: #fff;
  border: none;
  border-radius: 6px;
}

button:active {
  background: #0056b3;
}

h2 {
  text-align: center;
}
</style>
</head>

<body>

<h2>ระบบเบิกอะไหล่</h2>

<input id="searchMat" placeholder="ค้นหา Material#">
<input id="searchInst" placeholder="ค้นหา Instrument">

<button onclick="search()">ค้นหา</button>
<button onclick="loadData()">แสดงทั้งหมด</button>

<div id="list"></div>

<script>
let allData = [];

function loadData() {
  google.script.run.withSuccessHandler(data => {
    allData = data;
    render(data);
  }).getData();
}

function render(data) {
  const div = document.getElementById('list');
  div.innerHTML = '';

  data.forEach((r, i) => {
    div.innerHTML += `
      <div class="card">
        <b>Material#:</b> ${r['Material#']}<br>
        <b>Instrument:</b> ${r['Instrument']}<br>
        <b>Stock:</b> ${r['Stock']}<br>

        <input type="number" placeholder="เบิกออก" id="out${i}">
        <input type="number" placeholder="รับเข้า" id="in${i}">
        <input placeholder="ผู้เบิก" id="who${i}">

        <button onclick="save(${i}, '${r['Material#']}')">บันทึก</button>
      </div>
    `;
  });
}

function search() {
  const m = searchMat.value.toLowerCase();
  const ins = searchInst.value.toLowerCase();

  const f = allData.filter(r =>
    String(r['Material#']).toLowerCase().includes(m) &&
    String(r['Instrument']).toLowerCase().includes(ins)
  );

  render(f);
}

function save(i, material) {
  fetch('', {
    method: 'POST',
    body: JSON.stringify({
      material: material,
      outQty: document.getElementById(`out${i}`).value,
      inQty: document.getElementById(`in${i}`).value,
      who: document.getElementById(`who${i}`).value
    })
  })
  .then(r => r.json())
  .then(res => {
    alert(res.status === 'success' ? 'บันทึกแล้ว' : 'ไม่พบข้อมูล');
    loadData();
  });
}

loadData();
</script>

</body>
</html>
