<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>History Events - QIAGEN</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .history-card { 
            background: white; border-radius: 12px; padding: 15px; 
            margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex; justify-content: space-between; align-items: center;
            border-left: 6px solid #cbd5e1;
        }
        /* ‡πÅ‡∏¢‡∏Å‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó */
        .type-withdraw { border-left-color: #ef4444; }
        .type-return { border-left-color: #22c55e; }
        .type-transfer { border-left-color: #2563eb; }
        .type-add_stock { border-left-color: #3b82f6; }

        .info-container { flex: 1; margin-right: 10px; }
        .time-text { font-size: 11px; color: #94a3b8; display: block; }
        
        /* Material ‡πÅ‡∏•‡∏∞ Product Name ‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô */
        .product-line { 
            display: flex; gap: 8px; font-size: 13px; margin: 4px 0; 
            align-items: baseline; overflow: hidden;
        }
        .mat-id { font-weight: bold; color: #003366; white-space: nowrap; }
        .prod-name { color: #64748b; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .user-row { display: flex; align-items: center; gap: 8px; margin-top: 5px; }
        .user-tag { background: #f1f5f9; color: #475569; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; }
        .action-text { font-size: 11px; font-weight: bold; text-transform: uppercase; }

        .qty-badge { 
            background: #0f172a; color: white; width: 35px; height: 35px; 
            border-radius: 50%; display: flex; align-items: center; 
            justify-content: center; font-weight: bold; font-size: 14px; flex-shrink: 0;
        }
    </style>
</head>
<body onload="loadHistory()">
    <div class="container">
        <div style="display:flex; align-items:center; gap:15px; margin-bottom:20px;">
            <button onclick="location.href='user-select.html'" class="btn-sm" style="background:#fff; border:1px solid #ddd;">‚óÄ Back</button>
            <h2 style="margin:0; color:#0f172a; font-size: 20px;">History Events</h2>
        </div>
        <div id="history-list">
            <div style="text-align:center; padding:50px; color:#94a3b8;">‚åõ Loading history logs...</div>
        </div>
    </div>

    <script src="js/app.js"></script>
    <script>
        async function loadHistory() {
            const listNode = document.getElementById('history-list');
            try {
                // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡∏î‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÉ‡∏ô Code.gs ‡∏°‡∏µ handleGetHistory ‡πÅ‡∏•‡πâ‡∏ß)
                const response = await fetch(`${API}?action=gethistory&password=${PASSWORD}`);
                const res = await response.json();

                if (res.success && res.data.length > 0) {
                    listNode.innerHTML = res.data.map(item => {
                        // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏´‡∏≤‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏Ñ‡∏µ‡∏¢‡πå‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡∏Å‡∏£‡∏ì‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÉ‡∏ô Sheet ‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡πÄ‡∏õ‡πä‡∏∞
                        const material = item.Material || item.material || 'N/A';
                        const productName = item['Product Name'] || item.productname || '';
                        const actionType = item['Transaction Type'] || item.type || 'Unknown';
                        const user = item.User || item.user || 'System';
                        const qty = item.Qty || item.qty || 0;
                        const timestamp = item['Date and Time'] || item.timestamp || '';

                        const typeClass = actionType.toLowerCase().replace(' ', '_');

                        return `
                            <div class="history-card type-${typeClass}">
                                <div class="info-container">
                                    <span class="time-text">${timestamp}</span>
                                    <div class="product-line">
                                        <span class="mat-id">${material}</span>
                                        <span class="prod-name">${productName}</span>
                                    </div>
                                    <div class="user-row">
                                        <span class="user-tag">üë§ ${user}</span>
                                        <span class="action-text" style="color:${getActionColor(actionType)}">${actionType}</span>
                                    </div>
                                </div>
                                <div class="qty-badge">${qty}</div>
                            </div>
                        `;
                    }).join('');
                } else {
                    listNode.innerHTML = '<div style="text-align:center; padding:50px; color:#94a3b8;">No history found in TRANSACTION_LOG.</div>';
                }
            } catch (e) {
                listNode.innerHTML = '<div style="text-align:center; padding:50px; color:red;">‚ùå Connection Error. Please check API/Network.</div>';
                console.error(e);
            }
        }

        function getActionColor(type) {
            type = type.toLowerCase();
            if (type.includes('withdraw')) return '#ef4444';
            if (type.includes('return')) return '#22c55e';
            if (type.includes('transfer')) return '#2563eb';
            return '#64748b';
        }
    </script>
</body>
</html>
