<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>History Events - QIAGEN</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÄ‡∏™‡∏£‡∏¥‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
        body { background-color: #f8fafc; font-family: -apple-system, sans-serif; }
        .history-item { 
            background: #ffffff; border-radius: 12px; padding: 15px; 
            margin-bottom: 12px; display: flex; justify-content: space-between; 
            align-items: center; border-left: 6px solid #cbd5e1; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        /* ‡∏™‡∏µ‡πÅ‡∏¢‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ */
        .type-withdraw { border-left-color: #ef4444; } /* ‡πÅ‡∏î‡∏á */
        .type-return { border-left-color: #22c55e; }   /* ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß */
        .type-transfer { border-left-color: #3b82f6; } /* ‡∏ü‡πâ‡∏≤ */
        .type-add_stock { border-left-color: #8b5cf6; } /* ‡∏°‡πà‡∏ß‡∏á */
        .type-deduct_used { border-left-color: #f59e0b; } /* ‡∏™‡πâ‡∏° */

        .time-stamp { font-size: 11px; color: #94a3b8; display: block; margin-bottom: 4px; }
        .p-mat-line { font-weight: bold; color: #003366; font-size: 14px; margin-right: 8px; }
        .p-name-line { color: #64748b; font-size: 13px; display: block; }
        .user-tag { background: #f1f5f9; color: #475569; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; margin-top: 5px; display: inline-block; }
        .qty-circle { background: #003366; color: white; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0; }
        
        /* ‡∏õ‡∏∏‡πà‡∏° Reload ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏Å‡∏¥‡∏î Error */
        .btn-retry { background: #003366; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; margin-top: 15px; }
    </style>
</head>
<body>
    <div class="container">
        <div style="display:flex; align-items:center; gap:15px; margin: 20px 0;">
            <button onclick="location.href='user-select.html'" style="background:#fff; border:1px solid #ddd; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-weight: bold;">‚óÄ Back</button>
            <h2 style="margin:0; color:#003366; font-size: 20px;">History Events</h2>
        </div>

        <div id="history-list">
            <div style="text-align:center; padding:50px; color:#94a3b8;">
                <div class="spinner"></div>‚åõ Loading history logs...
            </div>
        </div>
    </div>

    <script>
        // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á (‡∏ï‡∏±‡∏ß‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≤)
        const API_URL = "https://script.google.com/macros/s/AKfycbxpAUr2ShX0LR5YFKqCzvc060_2m9_Wsp_tAx6qEwSJ-JwZT1aRF4Z5dLcgk2J8ZTRcuw/exec";
        const PASSWORD = "Service";

        async function loadHistory() {
            const listNode = document.getElementById('history-list');
            try {
                // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á Cache ‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏° Timestamp ‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ‡πÇ‡∏´‡∏°‡∏î Redirect
                const finalUrl = `${API_URL}?action=gethistory&password=${PASSWORD}&t=${new Date().getTime()}`;
                
                const response = await fetch(finalUrl, {
                    method: 'GET',
                    redirect: 'follow'
                });

                if (!response.ok) throw new Error('Network error');

                const res = await response.json();

                if (res.success && res.data && res.data.length > 0) {
                    listNode.innerHTML = res.data.map(item => {
                        // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏ö‡∏ö‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏ì‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÉ‡∏ô Sheet ‡∏°‡∏µ‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô)
                        const rawType = item['Transaction Type'] || 'Other';
                        const typeClass = rawType.toLowerCase().replace(' ', '_');
                        
                        return `
                            <div class="history-item type-${typeClass}">
                                <div style="flex:1; padding-right:10px;">
                                    <span class="time-stamp">${item['Date and Time'] || '-'}</span>
                                    <div>
                                        <span class="p-mat-line">${item['Material'] || '-'}</span>
                                        <span class="p-name-line">${item['Product Name'] || ''}</span>
                                    </div>
                                    <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
                                        <span class="user-tag">üë§ ${item['User'] || 'System'}</span>
                                        <span style="font-size:11px; font-weight:bold; color:#2563eb;">${rawType}</span>
                                    </div>
                                </div>
                                <div class="qty-circle">${item['Qty'] || 0}</div>
                            </div>
                        `;
                    }).join('');
                } else {
                    listNode.innerHTML = '<div style="text-align:center; padding:50px; color:#94a3b8;">No transaction history found.</div>';
                }

            } catch (err) {
                console.error("CORS or Fetch Error:", err);
                listNode.innerHTML = `
                    <div style="text-align:center; padding:50px;">
                        <p style="color:#ef4444; font-weight:bold;">‚ùå Connection Error (CORS)</p>
                        <p style="font-size:12px; color:#64748b; margin-top:10px;">
                            Browser blocked the request. This usually happens when the script is not deployed as "Anyone".
                        </p>
                        <button class="btn-retry" onclick="location.reload()">Try Again</button>
                    </div>
                `;
            }
        }

        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        window.onload = loadHistory;
    </script>
</body>
</html>
